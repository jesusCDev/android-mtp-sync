{% extends "base.html" %}

{% block title %}Dashboard - Phone Migration Tool{% endblock %}

{% block content %}
<div class="grid">
    <div class="card">
        <h2><i class="fas fa-mobile-alt"></i> Device Status</h2>
        <div id="device-status">
            <div class="spinner"></div>
        </div>
    </div>
    
    <div class="card">
        <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-success" onclick="runSync()"><i class="fas fa-play"></i> Run All Rules</button>
            <button class="btn" onclick="runSyncWithNotify()"><i class="fas fa-bell"></i> Run with Notifications</button>
            <a href="/rules" class="btn btn-secondary"><i class="fas fa-cog"></i> Manage Rules</a>
            <button class="btn btn-secondary" onclick="refreshStatus()"><i class="fas fa-sync-alt"></i> Refresh Status</button>
        </div>
    </div>
</div>

<div class="card">
    <h2><i class="fas fa-chart-line"></i> Recent Activity</h2>
    <div id="activity-log">
        <p style="color: #64748b;">No recent activity</p>
    </div>
</div>

<div id="alert-container"></div>

{% endblock %}

{% block extra_scripts %}
<script>
    let deviceStatus = null;
    
    async function loadDeviceStatus() {
        try {
            const status = await apiGet('/api/status');
            deviceStatus = status;
            
            const statusHtml = status.connected
                ? `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span class="status-badge connected"><i class="fas fa-check-circle"></i> Connected</span>
                    </div>
                    <div style="color: #94a3b8; line-height: 1.8;">
                        <p><strong style="color: #cbd5e1;">Device:</strong> ${status.device_name}</p>
                        <p><strong style="color: #cbd5e1;">Profile:</strong> ${status.profile_name}</p>
                        <p><strong style="color: #cbd5e1;">Rules:</strong> ${status.rule_count} configured</p>
                    </div>
                `
                : `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span class="status-badge disconnected"><i class="fas fa-times-circle"></i> Disconnected</span>
                    </div>
                    <div style="color: #94a3b8; line-height: 1.8;">
                        <p>No phone connected or device not registered</p>
                        <p style="margin-top: 10px; font-size: 14px; color: #64748b;">
                            <i class="fas fa-info-circle"></i> Connect your phone via USB and enable File Transfer mode
                        </p>
                    </div>
                `;
            
            document.getElementById('device-status').innerHTML = statusHtml;
        } catch (error) {
            document.getElementById('device-status').innerHTML = `
                <div class="alert alert-danger">
                    Error loading device status: ${error.message}
                </div>
            `;
        }
    }
    
    function showAlert(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        
        const container = document.getElementById('alert-container');
        container.appendChild(alertDiv);
        
        setTimeout(() => alertDiv.remove(), 5000);
    }
    
    async function runSync() {
        if (!deviceStatus || !deviceStatus.connected) {
            showAlert('Please connect your phone first', 'danger');
            return;
        }
        
        try {
            const result = await apiPost('/api/run', {notify: false});
            if (result.success) {
                showAlert('Sync started! Check the Run page for progress');
                setTimeout(() => window.location.href = '/run', 1000);
            } else {
                showAlert(result.error || 'Failed to start sync', 'danger');
            }
        } catch (error) {
            showAlert(`Error: ${error.message}`, 'danger');
        }
    }
    
    async function runSyncWithNotify() {
        if (!deviceStatus || !deviceStatus.connected) {
            showAlert('Please connect your phone first', 'danger');
            return;
        }
        
        try {
            const result = await apiPost('/api/run', {notify: true});
            if (result.success) {
                showAlert('Sync started with notifications enabled!');
                setTimeout(() => window.location.href = '/run', 1000);
            } else {
                showAlert(result.error || 'Failed to start sync', 'danger');
            }
        } catch (error) {
            showAlert(`Error: ${error.message}`, 'danger');
        }
    }
    
    function refreshStatus() {
        document.getElementById('device-status').innerHTML = '<div class="spinner"></div>';
        loadDeviceStatus();
    }
    
    // Load on page load
    loadDeviceStatus();
    
    // Auto-refresh every 5 seconds
    setInterval(loadDeviceStatus, 5000);
</script>
{% endblock %}
