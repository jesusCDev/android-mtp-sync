{% extends "base.html" %}
{% block title %}Dashboard - SyncDroid{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h2><i class="fas fa-mobile-alt"></i> Device Status</h2>
    <div id="device-status">
        <div class="spinner"></div>
    </div>
</div>

<div class="card">
    <h2><i class="fas fa-play-circle"></i> Run Operations</h2>
    
    <div id="run-status-indicator" class="status-indicator">
        <i class="fas fa-circle" style="color: var(--text-muted); font-size: 10px;"></i>
        <span id="run-status-text" style="color: var(--text-muted);">Ready to run</span>
    </div>
    
    <div class="run-options" style="margin-top: 16px;">
        <div class="option-card selected" onclick="toggleOption('dry_run')" id="dry-run-option">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-eye" style="color: var(--warning); font-size: 20px;"></i>
                <div>
                    <div style="font-weight: 600; color: var(--text); font-size: 14px;">Dry Run</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Preview changes without modifying</div>
                </div>
            </div>
            <div class="toggle-switch"></div>
        </div>
        
        <div class="option-card selected" onclick="toggleOption('notify')" id="notify-option">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-bell" style="color: var(--info); font-size: 20px;"></i>
                <div>
                    <div style="font-weight: 600; color: var(--text); font-size: 14px;">Notifications</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Get desktop alerts</div>
                </div>
            </div>
            <div class="toggle-switch"></div>
        </div>
        
        <div class="option-card selected" onclick="toggleOption('rename_duplicates')" id="rename-duplicates-option">
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-copy" style="color: var(--success); font-size: 20px;"></i>
                <div>
                    <div style="font-weight: 600; color: var(--text); font-size: 14px;">Rename on Conflict</div>
                    <div style="font-size: 12px; color: var(--text-muted);">Rename duplicates instead of skipping</div>
                </div>
            </div>
            <div class="toggle-switch"></div>
        </div>
    </div>
    
    <!-- Command Preview Card - Always visible and dynamic -->
    <div id="command-preview-card" style="margin-top: 16px; padding: 16px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-card);">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-terminal"></i> Command Preview</div>
        <div id="command-preview-content"></div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px;">
        <button id="run-btn" class="btn btn-success" onclick="startRun()" style="width: 100%;">
            <i class="fas fa-play"></i> Run All Rules
        </button>
        <button id="manual-btn" class="btn btn-secondary" onclick="openManualRulesModal()" style="width: 100%;">
            <i class="fas fa-hand-paper"></i> Run Manual Rules
        </button>
    </div>
</div>

<!-- Rules Preview Section (Collapsible) - Full Width Below -->
<div class="card" id="rules-preview-card" style="cursor: pointer;" onclick="toggleRulesPreview()">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <h2 style="margin: 0;"><i class="fas fa-list" id="preview-icon"></i> <span id="rules-preview-title">Rules to Execute</span></h2>
        <i class="fas fa-chevron-down" id="preview-chevron" style="color: var(--text-muted); font-size: 16px; transition: transform 0.2s;"></i>
    </div>
    <div id="rules-preview-content" style="display: none; margin-top: 20px;"></div>
</div>

<!-- Manual Rules Selection Panel -->
<div class="card" id="manual-selection-card" style="display: none;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
        <h2 style="margin: 0;"><i class="fas fa-hand-paper"></i> Select Manual Rules</h2>
        <button class="btn btn-secondary btn-sm" onclick="closeManualSelection()">
            <i class="fas fa-times"></i> Cancel
        </button>
    </div>
    
    <div id="manual-rules-list" style="margin-bottom: 16px;">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
            <div style="margin-top: 12px;">Loading manual rules...</div>
        </div>
    </div>
    
    <!-- Manual Command Preview -->
    <div id="manual-command-preview" style="display: none; margin-bottom: 16px; padding: 16px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: var(--radius-card);">
        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-terminal"></i> Command Preview</div>
        <div id="manual-command-preview-content"></div>
    </div>
    
    <button id="run-selected-btn" class="btn btn-success" onclick="runSelectedManualRules()" style="width: 100%;">
        <i class="fas fa-play"></i> Run Selected Rules
    </button>
</div>

<div class="card" id="stats-card" style="display: none;">
    <h2><i class="fas fa-chart-bar"></i> Statistics</h2>
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value" id="stat-copied">0</div>
            <div class="stat-label">Files Copied</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="stat-skipped">0</div>
            <div class="stat-label">Files Skipped</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="stat-deleted">0</div>
            <div class="stat-label">Files Deleted</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="stat-errors">0</div>
            <div class="stat-label">Errors</div>
        </div>
    </div>
    <div id="smart-copy-progress" style="display: none; margin-top: 20px; padding: 16px; background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); border-radius: var(--radius-card);">
        <div style="margin-bottom: 12px; font-size: 14px; color: var(--text);">
            <strong id="smart-copy-status">Smart Copy Progress</strong>
        </div>
        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;" id="smart-copy-current"></div>
        <div style="width: 100%; height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; overflow: hidden;">
            <div id="smart-copy-bar" style="height: 100%; background: linear-gradient(90deg, var(--info), var(--success)); width: 0%; transition: width 300ms ease;"></div>
        </div>
    </div>
</div>

<div class="card" id="output-card" style="display: none;">
    <h2><i class="fas fa-list-alt"></i> Operations</h2>
    <div id="operations-container"></div>
</div>

<div id="alert-container"></div>
{% endblock %}
