{% extends "base.html" %}
{% block title %}Rules - Phone Migration Tool{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/rules.css') }}">
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/rules.js') }}"></script>
{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="margin: 0;"><i class="fas fa-cog"></i> Rules</h2>
        <button class="btn btn-success" onclick="openAddModal()"><i class="fas fa-plus"></i> Add Rule</button>
    </div>
    
    <div id="profile-info" style="margin-bottom: 20px; padding: 12px 16px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle); border-radius: var(--radius-card); display: none;">
        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Current Device</div>
        <div id="current-profile" style="font-weight: 600; color: var(--text); font-size: 16px;"></div>
    </div>
    
    <div id="rules-container">
        <div class="spinner"></div>
    </div>
</div>

<!-- Add/Edit Rule Modal -->
<div id="rule-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-plus-circle"></i> <span id="modal-title">Add Rule</span></h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="rule-form" onsubmit="saveRule(event)">
            <div class="form-group">
                <label for="mode">Mode</label>
                <select id="mode" required>
                    <option value="">Select mode...</option>
                    <option value="move">Move (phone → desktop, delete from phone)</option>
                    <option value="copy">Copy (phone → desktop, keep on phone)</option>
                    <option value="smart_copy">Smart Copy (resumable, tracks progress)</option>
                    <option value="sync">Sync (desktop → phone, mirror)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="phone-path">Phone Path</label>
                <div class="input-with-button">
                    <input type="text" id="phone-path" placeholder="e.g., /DCIM/Camera" required>
                    <button type="button" class="btn btn-small btn-secondary" onclick="openPhoneBrowser()" aria-label="Browse phone folders">
                        <i class="fas fa-folder-open"></i> Browse
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="desktop-path">Desktop Path</label>
                <div class="input-with-button">
                    <input type="text" id="desktop-path" placeholder="e.g., ~/Pictures" required>
                    <button type="button" class="btn btn-small btn-secondary" onclick="openDesktopBrowser()" aria-label="Browse desktop folders">
                        <i class="fas fa-folder-open"></i> Browse
                    </button>
                </div>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="manual-only" style="width: auto;">
                    <span>Manual only (skip during automatic runs)</span>
                </label>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="submit" class="btn btn-success" style="flex: 1;">Save Rule</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Folder Browser Modal -->
<div id="browser-modal" class="browser-modal">
    <div class="browser-content">
        <div class="browser-header">
            <h3><i class="fas fa-folder-open"></i> <span id="browser-title">Browse Folders</span></h3>
            <button class="close-btn" onclick="closeBrowser()">&times;</button>
        </div>
        
        <div class="browser-breadcrumbs" id="browser-breadcrumbs">
            <i class="fas fa-home"></i>
        </div>
        
        <div class="browser-toolbar">
            <button class="btn btn-small" onclick="goUpOneLevel()" id="btn-up">
                <i class="fas fa-level-up-alt"></i> Up
            </button>
            <input type="text" id="browser-path-input" placeholder="Enter path..." onkeypress="if(event.key==='Enter')navigateToTypedPath()" style="flex: 1; padding: 8px 12px; background: #141821; border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text); font-size: 13px;">
            <button class="btn btn-small btn-secondary" onclick="navigateToTypedPath()">
                <i class="fas fa-arrow-right"></i> Go
            </button>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 0 12px; font-size: 13px; color: var(--text-muted); user-select: none;">
                <input type="checkbox" id="show-hidden-toggle" onchange="toggleHiddenFiles()" style="cursor: pointer;">
                <span>Show hidden</span>
            </label>
            <button class="btn btn-small btn-success" onclick="showCreateFolderPrompt()" title="Create new folder">
                <i class="fas fa-folder-plus"></i> New Folder
            </button>
        </div>
        
        <div class="browser-list" id="browser-list">
            <div class="spinner"></div>
        </div>
        
        <div class="browser-footer">
            <button class="btn btn-secondary" onclick="closeBrowser()">Cancel</button>
            <button class="btn btn-success" onclick="selectCurrentPath()" id="btn-select">Select Current Folder</button>
        </div>
    </div>
</div>

<div id="alert-container" style="position: fixed; top: 80px; right: 24px; z-index: 2000; max-width: 400px;"></div>
{% endblock %}
